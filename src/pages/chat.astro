---
import MainLayout from "@/layouts/main-layout.astro";
---

<MainLayout
  title="Join Slack"
  description="Join our private Slack channel"
  mainClass="bg-background-200"
>
  <div class="relative flex w-full min-h-svh items-center justify-center">
    <div
      class="px-4 py-5 sm:p-6 bg-background border rounded-xl overflow-hidden -mt-36"
    >
      <div class="flex flex-col gap-y-4 w-full max-w-sm">
        <div class="space-y-3">
          <img src="https://cdn.brandfetch.io/idJ_HhtG0Z/theme/dark/symbol.svg?k=bfHSJFAPEG" width="70" alt="Slack Logo">
          <h1 class="text-2xl font-heading tracking-wide">Join our private Slack Connect room</h1>
          <p class="text-sm text-muted-foreground">
            Talk to the team in a private and secure realtime chat channel.
          </p>
        </div>

        <form id="slackForm" class="space-y-4">
          <input
            type="email"
            name="email"
            required
            placeholder="Enter your email"
            class="w-full px-3 py-2 border rounded-lg"
          />
          <button
            type="submit"
            class="w-full bg-primary text-primary-foreground px-4 py-2 rounded-lg"
          >
            Request Invite
          </button>
        </form>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  function isWorkEmail(email: string) {
    // Exclude common personal email domains
    const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'aol.com'];
    const domain = email.split('@')[1].toLowerCase();
    return !personalDomains.includes(domain);
  }

  const form = document.getElementById('slackForm') as HTMLFormElement;
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const email = formData.get('email') as string;

    if (!isWorkEmail(email)) {
      alert('Please use your work email address');
      return;
    }

    try {
      const response = await fetch('/api/create-discord-invite', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email }),
      });

      const data = await response.json();
      
      if (response.ok) {
        window.location.href = data.inviteUrl;
      } else {
        alert(`Error: ${data.error}`);
      }
    } catch (error) {
      alert('Failed to create invite. Please try again.');
    }
  });
</script>
